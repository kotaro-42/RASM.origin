<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <meta name="rnbo-version" content="1.0.0-alpha.5">
    <link rel="stylesheet" href="style/style.css">
    <title>RASM origin</title>

    <style>
        /* 不要UIまとめて非表示 */
        #rnbo-clickable-keyboard,
        #rnbo-inports,
        #rnbo-console,
        #rnbo-presets {
            display: none !important;
        }
    </style>
</head>

<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <svg id="background" width="100%" height="100%"></svg>

    <div id="rnbo-root">
        <div>
            <h1 id="patcher-title">RASM origin</h1>
        </div>

        <!-- RNBOが内部でUIを追加するため、このDOMは削除禁止 -->
        <div id="rnbo-clickable-keyboard"></div>
        <div id="rnbo-inports"></div>
        <div id="rnbo-console"></div>
        <div id="rnbo-presets"></div>

        <!-- ★ RNBO が自動生成する部分なので、中身を触らないこと！ -->
        <div id="rnbo-parameter-sliders">
            <h2>Parameters</h2>
            <em id="no-param-label">No parameters</em>
        </div>
    </div>

    <!-- RNBO 必須 -->
    <script src="js/guardrails.js"></script>
    <script src="js/app.js"></script>

    <!-- マイク入力接続 -->
    <script>
    (async () => {
        while (!window.rnboDevice || !window.rnboContext) {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        const ctx = window.rnboContext;
        const dev = window.rnboDevice;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const src = ctx.createMediaStreamSource(stream);
            src.connect(dev.node);
        } catch (e) {
            console.error("mic error:", e);
        }
    })();
    </script>

    <!-- パラメータ離散化処理 -->
    <script>
    window.addEventListener('DOMContentLoaded', () => {
        const poll = setInterval(() => {
            const rows = document.querySelectorAll('#rnbo-parameter-sliders > div');
            if (rows.length < 5) return; // RNBO生成待ち

            clearInterval(poll);

            const getRange = (index) =>
                rows[index]?.querySelector('input[type="range"]');

            const volume = getRange(0);
            const sensitivity = getRange(1);
            const responsiveness = getRange(2);
            const dynamics = getRange(3);
            const release = getRange(4);

            function setDiscrete(range, steps, cls) {
                if (!range) return;
                const min = parseFloat(range.min || 0);
                const max = parseFloat(range.max || 1);
                range.step = (max - min) / (steps - 1);
                range.classList.add(cls);
            }

            setDiscrete(sensitivity, 12, 'range-ticks-12');
            setDiscrete(responsiveness, 10, 'range-ticks-10');
            setDiscrete(dynamics, 4, 'range-ticks-4');
            setDiscrete(release, 10, 'range-ticks-10');
        }, 50);
    });
    </script>

</body>
</html>
